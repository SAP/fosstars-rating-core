package com.sap.oss.phosphor.fosstars.data.github;

import static com.sap.oss.phosphor.fosstars.model.feature.oss.OssFeatures.ENABLED_VULNERABILITY_ALERTS_ON_GITHUB;
import static com.sap.oss.phosphor.fosstars.model.other.Utils.setOf;

import com.sap.oss.phosphor.fosstars.model.Feature;
import com.sap.oss.phosphor.fosstars.model.Value;
import com.sap.oss.phosphor.fosstars.model.ValueSet;
import com.sap.oss.phosphor.fosstars.model.feature.oss.OssFeatures;
import com.sap.oss.phosphor.fosstars.model.subject.oss.GitHubProject;
import com.sap.oss.phosphor.fosstars.model.value.ValueHashSet;
import java.io.IOException;
import java.util.Objects;
import java.util.Set;
import org.apache.http.HttpHeaders;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.kohsuke.github.GitHub;
import org.kohsuke.github.GitHubBuilder;

/**
 * This data provider gather info about vulnerability alerts in a project.
 * The provider fills out the following features:
 * <ul>
 *   <li>{@link OssFeatures#ENABLED_VULNERABILITY_ALERTS_ON_GITHUB}</li>
 * </ul>
 */
public class VulnerabilityAlertsInfo extends GitHubCachingDataProvider {

  /**
   * A token for accessing GitHub API.
   */
  private final String token;

  /**
   * Initializes a data provider.
   *
   * @param fetcher An interface to GitHub.
   * @param token A token for accessing GitHub API.
   */
  public VulnerabilityAlertsInfo(GitHubDataFetcher fetcher, String token) {
    super(fetcher);
    Objects.requireNonNull(token, "Oops! Token is null!");
    this.token = token;
  }

  @Override
  public Set<Feature<?>> supportedFeatures() {
    return setOf(ENABLED_VULNERABILITY_ALERTS_ON_GITHUB);
  }

  @Override
  protected ValueSet fetchValuesFor(GitHubProject project) {
    logger.info("Gathering info about vulnerability alerts ...");
    return ValueHashSet.from(enabledVulnerabilityAlerts(project));
  }

  /**
   * Check if vulnerability alerts are enabled for a project.
   *
   * @param project The project.
   * @return A value of {@link OssFeatures#ENABLED_VULNERABILITY_ALERTS_ON_GITHUB}.
   * @see <a href="https://docs.github.com/en/rest/reference/repos#check-if-vulnerability-alerts-are-enabled-for-a-repository">Check if vulnerability alerts are enabled for a repository</a>
   */
  private Value<Boolean> enabledVulnerabilityAlerts(GitHubProject project) {
    try (CloseableHttpClient client = httpClient()) {
      String url = String.format("https://api.github.com/repos/%s/%s/vulnerability-alerts",
          project.organization().name(), project.name());
      HttpGet request = new HttpGet(url);
      request.addHeader(HttpHeaders.ACCEPT, "application/vnd.github.dorian-preview+json");
      request.addHeader(HttpHeaders.AUTHORIZATION, String.format("Bearer %s", token));
      try (CloseableHttpResponse response = client.execute(request)) {
        return ENABLED_VULNERABILITY_ALERTS_ON_GITHUB.value(
            response.getStatusLine().getStatusCode() == 204);
      }
    } catch (IOException e) {
      logger.warn("Oops! Could not check whether vulnerability alerts are enabled or not", e);
    }

    return ENABLED_VULNERABILITY_ALERTS_ON_GITHUB.unknown();
  }

  /**
   * Creates an HTTP client.
   *
   * @return A new HTTP client.
   */
  CloseableHttpClient httpClient() {
    return HttpClients.createDefault();
  }

  /**
   * Command-line interface for testing.
   *
   * @param args Command-line options.
   * @throws Exception If something went wrong.
   */
  public static void main(String... args) throws Exception {
    String token = args[0];
    String url = args[1];
    GitHub github = new GitHubBuilder().withOAuthToken(token).build();
    GitHubDataFetcher fetcher = new GitHubDataFetcher(github);
    VulnerabilityAlertsInfo provider = new VulnerabilityAlertsInfo(fetcher, token);
    GitHubProject project = GitHubProject.parse(url);
    ValueSet values = provider.fetchValuesFor(project);
    System.out.println(values.of(ENABLED_VULNERABILITY_ALERTS_ON_GITHUB));
  }

}
